{
    "collab_server" : "",
    "contents" : "---\ntitle: \"vignette to stageR: stage-wise analysis of high-throughput gene expression data in R\"\nauthor: \"Koen Van den Berge\"\ndate: \"`r Sys.Date()`\"\nbibliography: /Users/koenvandenberge/Documents/Mendeley/library.bib\noutput: rmarkdown::html_vignette\nvignette: >\n  %\\VignetteIndexEntry{stageR}\n  %\\VignetteEngine{knitr::rmarkdown}\n  %\\VignetteEncoding{UTF-8}\n---\n\nThis vignette describes the stageR package that has been developed for stage-wise analysis of high throughput data. A stage-wise analysis was shown to be beneficial in terms of biological interpretation and statistical performance when multiple hypotheses per gene are of interest.\nThe stage-wise analysis has been adopted from [@Heller2009] and consists of a screening stage and a confirmation stage. In the screening stage, genes are screened by calculating p-values that aggregate evidence across the different hypotheses of interest for the gene. The p-values are then adjusted for FDR control after which significance of the screening hypothesis is assessed.\nIn the confirmation stage, only the genes passing the screening stage are retained. For those genes, every hypothesis of interest is assessed separately and multiple testing correction is performed within a gene according to FWER control.\n`stageR` provides an automated way to perform stage-wise testing, given p-values for the screening and confirmation stages. A number of FWER control procedures that take into account the logical relations among the hypotheses are implemented. Since the logical relations are specific to the experiment, the user can also specify an adjustment deemed appropriate.\n\n# Differential gene expression: Hammer dataset\n\n```{r,echo=FALSE,warning=FALSE}\nsuppressPackageStartupMessages({library(edgeR) ; library(Biobase) ; library(limma) ; library(utils) ; library(devtools) ; library(DEXSeq)})\ndevtools::load_all(\"~/Dropbox/PhD/Research/stageWiseTesting/stageR/stageR/\")\n#library(stageR)\n```\n\nAs a case study for differential gene expression analysis, we analyse the Hammer dataset [@Hammer2010]. We first download the expressionSet from the ReCount project [website](http://bowtie-bio.sourceforge.net/recount) [@Frazee2011].\n\n```{r}\n#download.file(\"http://bowtie-bio.sourceforge.net/recount/ExpressionSets/hammer_eset.RData\",destfile=\"~/hammer_eset.RData\")\nload(\"~/hammer_eset.RData\")\neset = hammer.eset ; rm(hammer.eset)\n```\n\nThe Hammer experiment investigated the effect of a spinal nerve ligation (SNL)versus a control in rats at two weeks and two months after treatment. For every time $\\times$ treatment combination, 2 biological replicates were used. The hypotheses of interest are\n\n - the treatment effect at the first timepoint,\n - the treatment effect at the second timepoint and\n - assessment whether the effect of the treatment is different between the two timepoints (i.e. the treatment-time interaction) \n \nWe use a contrast for the differential expression at the first and second timepoint and a difference in fold change between the two timepoints, respectively. \nTherefore we create a design matrix consisting of two timepoints, two treatments and two biological replicates in every treatment $\\times$ time combination. Note there has been a typo in the phenoData, so we will correct it first.\n\n```{r}\neset@phenoData@data$Time #typo. Will do it ourself\ntime = factor(rep(c(\"mo2\",\"w2\"),each=4),levels=c(\"w2\",\"mo2\"))\neset@phenoData@data$protocol\ntreat = factor(c(\"control\",\"control\",\"SNL\",\"SNL\",\"control\",\"control\",\"SNL\",\"SNL\"),levels=c(\"control\",\"SNL\"))\ndesign = model.matrix(~time*treat)\nrownames(design) = paste0(time,treat,rep(1:2,4))\ncolnames(design)[4] = \"timeMo2xTreatSNL\"\n```\n\nWe perform indpendent filtering [@Bourgon2010] of the genes where we retain genes that are expressed with at least 2 counts per million in 2 samples.\nThe data is then normalised with TMM normalisation [@Robinson2010] to correct for differences in sequencing depth and RNA population between the samples.\n\n```{r}\ncpmOffset=2\nkeep = rowSums(cpm(exprs(eset))>cpmOffset)>=2 #2cpm in 2 samples\nd = DGEList(exprs(eset)[keep,])\ncolnames(d) = rownames(design)\nd = calcNormFactors(d)\n```\n\nIn order to test the three hypotheses of interest, we build a contrast matrix L. The rows of the contrast matrix correspond to the coefficients in the model and the columns correspond to contrasts.\n\n```{r}\nL=matrix(0,ncol=3,nrow=ncol(design))\ncolnames(L)=c(\"SNL-C_w2\",\"SNL-C_mo2\",\"SNL-C_mo2-w2\")\nrownames(L)=colnames(design)\nL[\"treatSNL\",1]=1\nL[grep(rownames(L),pattern=\"SNL\"),2]=1\nL[,3]=L[,2]-L[,1]\nL\n```\n\n## Conventional analysis\n\nWe will first analyse the data with limma-voom [@Law2014] in a standard way: the three contrasts are assessed separately on an FDR level of $5\\%$. \n\n```{r}\n## regular analysis\nv = voom(d,design,plot=TRUE)\nfit=lmFit(v,design)\ncontrast.matrix <- makeContrasts(treatSNL, treatSNL+timeMo2xTreatSNL, timeMo2xTreatSNL, levels=design)\nfit2 = contrasts.fit(fit, contrast.matrix)\nfit2 <- eBayes(fit2)\nres=decideTests(fit2)\nsummary.TestResults(res) #nr of significant up-/downregulated genes\ncolSums(summary.TestResults(res)[c(1,3),]) #total nr of significant genes\nuniqueGenesRegular=which(res[,1]!=0 | res[,2]!=0 | res[,3]!=0)\nlength(uniqueGenesRegular) #total nr of significant genes\n```\n\nThe conventional analysis does not find any genes that have a different effect of the treatment between the two timepoints (i.e. the interaction effect test), while many genes are differentially expressed between treatment and control within every timepoint. In total, `r length(uniqueGenesRegular)` genes are found to be differentially expressed following a spinal nerve ligation, but FDR was not controlled at the gene level so we cannot state a target FDR level together with this number.\n\n## Stage-wise analysis\n\nThe stage-wise analysis first considers an omnibus test that tests whether any of the three contrasts are significant, i.e. it tests whether there has been any effect of the treatment whatsoever.\nFor the screening hypothesis, we use the `topTableF` function from the `limma` package to perform an F-test across the three contrasts. The screening hypothesis p-values are then stored in the vector `pScreen`.\n\n```{r}\n#library(stageR)\nalpha=0.05\nnGenes=nrow(d)\ntableF = topTableF(fit2, number=nGenes, sort.by=\"none\") #screening hypothesis\npScreen=tableF$P.Value\n```\n\nIn the confirmation stage, every contrast is assessed separately. The confirmation stage p-values are adjusted to control the FWER across the hypotheses within a gene. The function `buildStageR` constructs an object from the `stageR` class and requires a (preferably named) vector of p-values for the screening hypothesis and a (preferably named) matrix of p-values for the different contrasts of interest. The `pScreenAdjusted` argument specifies whether the screening p-values have already been adjusted to control for the FDR.\nThe function `stageWiseAdjustment` then controls the p-values according to a stage-wise analysis. The `method` argument specifies the FWER correction procedure to be used in the confirmation stage. More details on the different methods can be found in the help file for `stageWiseAdjustment`. The `alpha` argument specifies the target OFDR level that is used for controlling false positive genes over the entire stage-wise testing procedure. The adjusted p-values for genes that did not pass the screening stage are always set to $1$.\n\n\nNote that when a gene passed the screening hypothesis in the Hammer experiment, only one null hypothesis can still be true: there has to be DE at timepoint 1 or timepoint 2; if the DE only occurs on one timepoint there also exist an interaction; if DE occurs at both timepoints, the H0 of no interaction can still be true. Thus, according to Shaffer's procedure [@Shaffer1986], no FWER correction is required in the confirmation stage for this experiment. This can be specified with the `method=\"none\"` argument.\n\n\n```{r}\npConfirmation=sapply(1:3,function(i) topTable(fit2, coef=i, number=nGenes, sort.by=\"none\")$P.Value)\ndimnames(pConfirmation)=list(rownames(fit2),c(\"t1\",\"t2\",\"t1t2\"))\nstageRObj <- buildStageR(pScreen=pScreen, pConfirmation=pConfirmation, pScreenAdjusted=FALSE)\nadjustedPSW <- stageWiseAdjustment(object=stageRObj, method=\"none\", alpha=0.05)\n```\n\nWe can explore the results of the stage-wise analysis by querying the object returned by `stageWiseAdjustment`. *Note that the confirmation stage adjusted p-values returned by the function have to be compared with the adjusted significance level from the screening stage for the analysis to be valid.* The adjusted significance level can be accessed by \n\n```{r}\nadjustedAlphaLevel(adjustedPSW)\n```\n\nwhich shows that the adjusted significance level for the Hammer dataset is `r round(adjustedAlphaLevel(adjustedPSW),2)*100`%. The adjusted p-values from the confirmation stage can be accessed with the `getAdjustedPValues` function:\n\n```{r}\nhead(getAdjustedPValues(adjustedPSW, onlySignificantGenes=FALSE))\nhead(getAdjustedPValues(adjustedPSW, onlySignificantGenes=TRUE))\n```\n\nand may either return all p-values or only those from the significant genes, as specified by the `onlySignificantGenes` argument. Finally, the `getResults` function returns a 0/1 matrix where rows correspond to features and columns correspond to hypotheses, including the screening hypothesis. For every feature $\\times$ hypothesis combination, it indicates whether the test is significant (1) or not (0) according to the stage-wise testing procedure. For the screening hypothesis the p-values are thus compared to the number specified by `alpha` while the confirmation adjusted p-values are compared to the adjusted significance level.\n\n```{r}\nres <- getResults(adjustedPSW)\nhead(res)\ncolSums(res) #stage-wise analysis results\n```\n\nThe `adjustment` argument to `stageWiseAdjustment` allows manual specification of the FWER adjustment correction. It requires a numeric vector of the same length as the number of columns in `pConfirmation`. The first element of the vector is the adjustment for the most significant p-value of the gene, the second element for the second most significant p-value etc. Since the Hammer dataset did not require any adjustment, identical results are obtained when manually specifying the adjustments to equal $1$.\n\n```{r}\nadjustedPSW <- stageWiseAdjustment(object=stageRObj, method=\"user\", alpha=0.05, adjustment=c(1,1,1))\nres <- getResults(adjustedPSW)\ncolSums(res)\n```\n\n\n\n# Differential transcript expression/usage\n\n\nMultiple hypotheses of interest per gene also arise in transcript level studies, where the different hypotheses correspond to the different isoforms for a gene.\nWe will analyse differential transcript usage for a case study that investigated expression in prostate cancer versus normal tissue in 14 Chinese patients [@Ren2012].\nThe raw sequences have been preprocessed with kallisto [@Bray2016] and transcript level abundance estimates can be downloaded from The Lair project [@Pimentel2016] [website](http://pachterlab.github.io/lair/). We used the unnormalized, unfiltered abundances for the analysis.\nA subset of the dataset comes with the `stageR` package and can be accessed with `data(esetProstate)` after loading `stageR`. The `ExpressionSet` contains the metadata for the samples in `pData(esetProstate)` and corresponding gene identifiers for the transcripts are stored in `fData(esetProstate)`. The dataset contains 32526 transcripts\n\n```{r}\n#data(\"esetProstate\",package=\"stageR\")\nload(\"/Users/koenvandenberge/Dropbox/PhD/Research/stageWiseTesting/stageR/stageR/data/esetProstate.rda\")\nhead(pData(esetProstate))\nhead(fData(esetProstate))\n```\n\nWe will perform some basic data exploration on the transcripts in the dataset. Since the dataset was preprocessed for the purposes of this vignette, every gene has at least two transcripts, and all transcripts are expressed in at least 1 sample.\n\n\n```{r}\ntx2gene = fData(esetProstate)\ncolnames(tx2gene)=c(\"transcript\",\"gene\")\nbarplot(table(table(tx2gene$gene)), main=\"Distribution of number of tx per gene\")\n\n#the dataset contains\nlength(unique(tx2gene$gene)) #nr genes\nmedian(table(as.character(tx2gene$gene))) #median nr of tx/gene\n```\n\nNext we show how you can use the `stageR` package to analyse DTU in a stage-wise approach. We start with a regular DEXseq analysis to obtain p-values for every transcript and q-values for every gene.\n\n```{r}\n### regular DEXSeq analysis\nsampleData=pData(esetProstate)\ngeneForEachTx <- tx2gene[match(rownames(exprs(esetProstate)),tx2gene[,1]),2]\ndxd <- DEXSeqDataSet(countData = exprs(esetProstate),\n                         sampleData = sampleData,\n                         design = ~ sample + exon + patient + condition:exon,\n                         featureID = rownames(esetProstate),\n                         groupID = as.character(geneForEachTx))\ndxd <- estimateSizeFactors(dxd)\ndxd <- estimateDispersions(dxd)\ndxd <- testForDEU(dxd, reducedModel = ~ sample + exon + patient)\ndxr <- DEXSeqResults(dxd)\ndxr$padj[is.na(dxr$padj)]=1\nqvalDxr <- perGeneQValue(dxr)\n```\n\nThe code above is a conventional `DEXSeq` analysis for analysing differential transcript usage. It would proceed by either assessing the significant genes according to the gene-wise q-values or by assessing the significant transcripts according to the transcript-level p-values, after adjustment for multiple testing. Performing and interpreting both analyses does not provide control of false positives and may get cumbersome. In the following code, we show how to automatically perform a stage-wise analysis using `stageR`. We start by constructing\n\n - a named matrix with transcript-level p-values `pConfirmation`\n - a named vector of gene-wise q-values `pScreen`\n - a `data.frame` with transcript identifiers and corresponding gene identifiers `tx2gene`\n \nThese three objects provide everything for the stage-wise analysis.\n\n```{r}\npConfirmation=matrix(dxr$pvalue,ncol=1)\ndimnames(pConfirmation)=list(c(dxr$featureID),c(\"transcript\"))\npScreen=qvalDxr\ntx2gene=fData(esetProstate)\n```\n\nNext we build an object from the `stageR` class and indicate that the screening hypothesis p-values were already adjusted by setting `pScreenAdjusted=TRUE`. Similar as in the DGE example, we port this object to the `stageWiseAdjustment` function for correcting the p-values. We control the analysis on a $5\\%$ target OFDR (`alpha=0.05`). `method=\"dtu\"` indicates the adapted Holm-Shaffer FWER correction that was specifically tailored for DTU analysis as described in the manuscript. In brief, we test the two most significant p-values on a $\\alpha/(n_g-2)$, with $n_g$ the number of transcripts for gene $g$, level and from the third transcript onwards the Holm correction [@Holm1979] is used.\n\n```{r}\nstageRObj <- buildStageR(pScreen=pScreen, pConfirmation=pConfirmation, pScreenAdjusted=TRUE)\nadjustedPStageWise <- stageWiseAdjustment(object=stageRObj, method=\"dtu\", alpha=0.05, tx2gene=tx2gene)\n```\n\nWe can then explore the results using a range of accessor functions. The significant genes can be returned with the `getSignificantGenes` function:\n\n```{r}\nhead(getSignificantGenes(adjustedPStageWise))\n```\n\nThe stage-wise adjusted p-values are returned using the `getAdjustedPValues` function. The screening (gene) hypothesis p-values were adjusted according to the BH FDR criterion and the confirmation (transcript) hypotheses were adjusted with the specified FWER control. Hence, the confirmation p-values returned from this function should be compared to the BH adjusted significance level of the first stage. The function returns a matrix where the different rows correspond to transcripts and the rownames correspond to gene and transcript identifiers separated with a dot:\n\n```{r}\npadj = getAdjustedPValues(adjustedPStageWise)\nhead(padj)\n```\n\nSimilar as in the DGE case study, a 0/1 matrix that indicates significance of the tests can be retrieved with the `getResults` function:\n\n```{r}\nres=getResults(adjustedPStageWise)\nhead(res)\n```\n\nTo show how to use the adjusted p-values we recreate this result manually:\n\n```{r}\ncolSums(res)\n\nsum(res[,1]) ; sum(getAdjustedPValues(adjustedPStageWise)[,1]<=0.05)\n\nsum(res[,2]) ; sum(getAdjustedPValues(adjustedPStageWise)[,2]<=adjustedAlphaLevel(adjustedPStageWise))\n```\n\n\n# References\n\n\n",
    "created" : 1482357776503.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1421418175",
    "id" : "32AA5A17",
    "lastKnownWriteTime" : 1482761251,
    "last_content_update" : 1482761251962,
    "path" : "~/Dropbox/PhD/Research/stageWiseTesting/stageR/stageR/vignettes/stageRVignette.Rmd",
    "project_path" : "vignettes/stageRVignette.Rmd",
    "properties" : {
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}