---
title: "vignette to stageR: stage-wise analysis of high-throughput gene expression data in R"
author: "Koen Van den Berge"
date: "`r Sys.Date()`"
bibliography: /Users/koenvandenberge/Documents/Mendeley/library.bib
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{stageR}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette describes how to use the stageR package that has been developed for stage-wise analysis of high throughput gene expression data in R. A stage-wise analysis was shown to be beneficial in terms of biological interpretation and statistical performance when multiple hypotheses per gene are of interest.
The stage-wise analysis has been adopted from [@Heller2009] and consists of a screening stage and a confirmation stage. In the screening stage, genes are screened by calculating p-values that aggregate evidence across the different hypotheses of interest for the gene. The screening p-values are then adjusted for FDR control after which significance of the screening hypothesis is assessed.
In the confirmation stage, only genes passing the screening stage are considered for analysis. For those genes, every hypothesis of interest is assessed separately and multiple testing correction is performed across hypotheses within a gene to control the FWER on the BH adjusted significance level of the screening stage, $\alpha_I$.
`stageR` provides an automated way to perform stage-wise testing, given p-values for the screening and confirmation stages. A number of FWER control procedures that take into account the logical relations among the hypotheses are implemented. Since the logical relations may be specific to the experiment, the user can also specify an adjustment deemed appropriate.

# Differential gene expression: Hammer dataset

```{r,echo=TRUE,warning=FALSE}
suppressPackageStartupMessages({library(edgeR) ; library(Biobase) ; library(limma) ; library(utils) ; library(devtools) ; library(DEXSeq)})
install_github("statOmics/stageR",auth_token="cb649b65157aa8cd235a992d99cbe9384fd0eeb2")
library(stageR)
```

As a case study for differential gene expression analysis, we analyse the Hammer dataset [@Hammer2010]. We first download the expressionSet from the ReCount project [website](http://bowtie-bio.sourceforge.net/recount) [@Frazee2011].

```{r}
download.file("http://bowtie-bio.sourceforge.net/recount/ExpressionSets/hammer_eset.RData",destfile="~/hammer_eset.RData")
load("~/hammer_eset.RData")
eset = hammer.eset ; rm(hammer.eset)
```

The Hammer experiment investigated the effect of a spinal nerve ligation (SNL) versus control samples in rats at two weeks and two months after treatment. For every time $\times$ treatment combination, 2 biological replicates were used. The hypotheses of interest are

 - the treatment effect at the first timepoint,
 - the treatment effect at the second timepoint and
 - assessing whether the effect of the treatment is different between the two timepoints (i.e. the treatment-time interaction) 
 
We use a contrast for the differential expression at the first and second timepoint and a difference in fold change between the two timepoints, respectively. 
Therefore we create a design matrix consisting of two timepoints, two treatments and two biological replicates in every treatment $\times$ time combination. Note there has been a typo in the phenoData, so we will correct this first.

```{r}
eset@phenoData@data$Time #typo. Will do it ourself
time = factor(rep(c("mo2","w2"),each=4),levels=c("w2","mo2"))
eset@phenoData@data$protocol
treat = factor(c("control","control","SNL","SNL","control","control","SNL","SNL"),levels=c("control","SNL"))
design = model.matrix(~time*treat)
rownames(design) = paste0(time,treat,rep(1:2,4))
colnames(design)[4] = "timeMo2xTreatSNL"
design
```

We perform indpendent filtering [@Bourgon2010] of the genes and retain genes that are expressed with at least 2 counts per million in 2 samples.
The data is then normalised with TMM normalisation [@Robinson2010] to correct for differences in sequencing depth and RNA population between the samples.

```{r}
cpmOffset=2
keep = rowSums(cpm(exprs(eset))>cpmOffset)>=2 #2cpm in 2 samples
d = DGEList(exprs(eset)[keep,])
colnames(d) = rownames(design)
d = calcNormFactors(d)
```

In order to test the three hypotheses of interest, we build a contrast matrix L. The rows of the contrast matrix correspond to the coefficients in the model and the columns correspond to contrasts.

```{r}
L=matrix(0,ncol=3,nrow=ncol(design))
colnames(L)=c("SNL-C_w2","SNL-C_mo2","SNL-C_mo2-w2")
rownames(L)=colnames(design)
L["treatSNL",1]=1
L[grep(rownames(L),pattern="SNL"),2]=1
L[,3]=L[,2]-L[,1]
L
```

## Conventional analysis

We will first analyse the data with limma-voom [@Law2014] in a standard way: the three contrasts are assessed separately on an FDR level of $5\%$. 

```{r}
## regular analysis
v = voom(d,design,plot=TRUE)
fit=lmFit(v,design)
contrast.matrix <- makeContrasts(treatSNL, treatSNL+timeMo2xTreatSNL, timeMo2xTreatSNL, levels=design)
fit2 = contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)
res=decideTests(fit2)
summary.TestResults(res) #nr of significant up-/downregulated genes
colSums(summary.TestResults(res)[c(1,3),]) #total nr of significant genes
```

The conventional analysis does not find any genes that have a different effect of the treatment between the two timepoints (i.e. the interaction effect test), while many genes are differentially expressed between treatment and control within every timepoint.

To get a global picture of the effect of SNL on the transcriptome, we can check how many genes are significantly altered following SNL.

```{r}
uniqueGenesRegular=which(res[,1]!=0 | res[,2]!=0 | res[,3]!=0)
length(uniqueGenesRegular) #total nr of significant genes
```

In total, `r length(uniqueGenesRegular)` genes are found to be differentially expressed following a spinal nerve ligation. However, FDR was only controlled at the contrast level and not at the gene level so we cannot state a target FDR level together with this number.

## Stage-wise analysis

The stage-wise analysis first considers an omnibus test that tests whether any of the three contrasts are significant, i.e. it tests whether there has been any effect of the treatment whatsoever.
For the screening hypothesis, we use the `topTableF` function from the `limma` package to perform an F-test across the three contrasts. The screening hypothesis p-values are then stored in the vector `pScreen`.

```{r}
alpha=0.05
nGenes=nrow(d)
tableF = topTableF(fit2, number=nGenes, sort.by="none") #screening hypothesis
pScreen=tableF$P.Value
```

In the confirmation stage, every contrast is assessed separately. The confirmation stage p-values are adjusted to control the FWER across the hypotheses within a gene. The function `buildStageR` constructs an object from the `stageR` class and requires a (preferably named) vector of p-values for the screening hypothesis and a (preferably named) matrix of p-values for the confirmation stage with columns corresponding to the different contrasts of interest. Note that the rows correspond to features (genes) and the features should be identically sorted in `pScreen` and `pConfirmation`. The `pScreenAdjusted` argument specifies whether the screening p-values have already been adjusted according to FDR control.

```{r}
pConfirmation=sapply(1:3,function(i) topTable(fit2, coef=i, number=nGenes, sort.by="none")$P.Value)
dimnames(pConfirmation)=list(rownames(fit2),c("t1","t2","t1t2"))
stageRObj <- buildStageR(pScreen=pScreen, pConfirmation=pConfirmation, pScreenAdjusted=FALSE)
```

The function `stageWiseAdjustment` then adjusts the p-values according to a stage-wise analysis. The `method` argument specifies the FWER correction procedure to be used in the confirmation stage. More details on the different methods can be found in the help file for `stageWiseAdjustment`. The `alpha` argument specifies the target OFDR level that is used for controlling the fraction of false positive genes across all rejected genes over the entire stage-wise testing procedure. The adjusted p-values for genes that did not pass the screening stage are always set to $1$.

Note that when a gene passed the screening hypothesis in the Hammer experiment, only one null hypothesis can still be true: there has to be DE at timepoint 1 or timepoint 2; if the DE only occurs on one timepoint there also exist an interaction; if DE occurs at both timepoints, the H0 of no interaction can still be true. Thus, according to Shaffer's MSRB procedure [@Shaffer1986], no correction is required in the confirmation stage for this experiment to control the FWER. This can be specified with the `method="none"` argument.


```{r}
adjustedPSW <- stageWiseAdjustment(object=stageRObj, method="none", alpha=0.05)
```

We can explore the results of the stage-wise analysis by querying the object returned by `stageWiseAdjustment`. **Note that the confirmation stage adjusted p-values returned by the function have to be compared with the adjusted significance level from the screening stage for the analysis to be valid.** The adjusted significance level can be accessed with the `adjustedAlphaLevel` function 

```{r}
adjustedAlphaLevel(adjustedPSW)
```

and shows that the adjusted significance level for the Hammer dataset is around `r round(adjustedAlphaLevel(adjustedPSW),2)*100`%. The adjusted p-values from the confirmation stage can be accessed with the `getAdjustedPValues` function:

```{r}
head(getAdjustedPValues(adjustedPSW, onlySignificantGenes=FALSE))
head(getAdjustedPValues(adjustedPSW, onlySignificantGenes=TRUE))
```

and may either return all p-values or only those from the significant genes, as specified by the `onlySignificantGenes` argument. Finally, the `getResults` function returns a 0/1 matrix where rows correspond to features and columns correspond to hypotheses, including the screening hypothesis. For every feature $\times$ hypothesis combination, it indicates whether the test is significant (1) or not (0) according to the stage-wise testing procedure. For the screening hypothesis the BH adjusted p-values are thus compared to the number specified by `alpha` while the confirmation adjusted p-values are compared to the adjusted significance level.

```{r}
res <- getResults(adjustedPSW)
head(res)
colSums(res) #stage-wise analysis results
```

The `adjustment` argument from the `stageWiseAdjustment` function allows the user to specify the FWER adjustment correction. It requires a numeric vector of the same length as the number of columns in `pConfirmation`. The first element of the vector is the adjustment for the most significant p-value of the gene, the second element for the second most significant p-value etc. Since the Hammer dataset did not require any adjustment, identical results are obtained when manually specifying the adjustments to equal $1$.

```{r}
adjustedPSW <- stageWiseAdjustment(object=stageRObj, method="user", alpha=0.05, adjustment=c(1,1,1))
res <- getResults(adjustedPSW)
colSums(res)
```

# Differential transcript expression/usage

Multiple hypotheses of interest per gene also arise in transcript level studies, where the different hypotheses correspond to the different isoforms for a gene.
We will analyse differential transcript usage for a case study that investigated expression in prostate cancer versus normal tissue in 14 Chinese patients [@Ren2012].
The raw sequences have been preprocessed with kallisto [@Bray2016] and transcript level abundance estimates can be downloaded from The Lair project [@Pimentel2016] [website](http://pachterlab.github.io/lair/). We used the unnormalized, unfiltered abundances for the analysis.
A subset of the dataset comes with the `stageR` package and can be accessed with `data(esetProstate)` after loading `stageR`. The `ExpressionSet` contains the metadata for the samples in `pData(esetProstate)` and corresponding gene identifiers for the transcripts are stored in `fData(esetProstate)`. The dataset contains 32526 transcripts from 456 genes.

```{r}
data("esetProstate") #from stageR package
head(pData(esetProstate))
head(fData(esetProstate))
```

We will perform some basic data exploration on the transcripts in the dataset. Since the dataset was preprocessed for the purposes of this vignette, every gene has at least two transcripts, and all transcripts are expressed in at least 1 sample.


```{r}
tx2gene = fData(esetProstate)
colnames(tx2gene)=c("transcript","gene")
barplot(table(table(tx2gene$gene)), main="Distribution of number of tx per gene")

#the dataset contains
length(unique(tx2gene$gene)) #nr genes
median(table(as.character(tx2gene$gene))) #median nr of tx/gene
```

We will show how to use the `stageR` package to analyse DTU with a stage-wise approach. We start with a regular DEXseq analysis to obtain p-values for every transcript and q-values for every gene. Since both control and tumoral tissue are derived from the same patient for all 14 patients, we add a block effect for the patient to account for the correlation between samples within every patient.

```{r}
### regular DEXSeq analysis
sampleData=pData(esetProstate)
geneForEachTx <- tx2gene[match(rownames(exprs(esetProstate)),tx2gene[,1]),2]
dxd <- DEXSeqDataSet(countData = exprs(esetProstate),
                         sampleData = sampleData,
                         design = ~ sample + exon + patient + condition:exon,
                         featureID = rownames(esetProstate),
                         groupID = as.character(geneForEachTx))
dxd <- estimateSizeFactors(dxd)
dxd <- estimateDispersions(dxd)
dxd <- nbinomLRT(dxd, reduced=~ sample + exon + patient)
dxr <- DEXSeqResults(dxd)
dxr$padj[is.na(dxr$padj)]=1
qvalDxr <- perGeneQValue(dxr)
```

The code above is a conventional `DEXSeq` analysis for analysing differential transcript usage. It would proceed by either assessing the significant genes according to the gene-wise q-values or by assessing the significant transcripts according to the transcript-level p-values, after adjustment for multiple testing. Performing and interpreting both analyses does not provide appropriate FDR control and thus should be avoided. However, interpretation on the gene level combined with transcript level results may be interesting and this can be achieved through stage-wise testing. In the following code, we show how to automatically perform a stage-wise analysis using `stageR`. We start by constructing

 - a named vector of gene-wise q-values `pScreen`
 - a named matrix with transcript-level p-values `pConfirmation`
 - a `data.frame` with transcript identifiers and corresponding gene identifiers `tx2gene`
 
These three objects provide everything we need for the stage-wise analysis.

```{r}
pConfirmation=matrix(dxr$pvalue,ncol=1)
dimnames(pConfirmation)=list(c(dxr$featureID),c("transcript"))
pScreen=qvalDxr
tx2gene=fData(esetProstate)
```

Next we build an object from the `stageR` class and indicate that the screening hypothesis p-values were already adjusted by setting `pScreenAdjusted=TRUE`. Similar as in the DGE example, we port this object to the `stageWiseAdjustment` function for correcting the p-values. We control the analysis on a $5\%$ target OFDR (`alpha=0.05`). `method="dtu"` indicates the adapted Holm-Shaffer FWER correction that was specifically tailored for DTU analysis as described in the manuscript. In brief, the Holm procedure [@Holm1979] is used from the third transcript onwards and the two most significant p-values are tested on a $\alpha_I/(n_g-2)$ significance level, with $\alpha_I$ the BH adjusted significance level from the screening stage and $n_g$ the number of transcripts for gene $g$.

```{r}
stageRObj <- stageR(pScreen=pScreen, pConfirmation=pConfirmation, pScreenAdjusted=TRUE)
adjustedPStageWise <- stageWiseAdjustment(object=stageRObj, method="dtu", alpha=0.05, tx2gene=tx2gene)
```

We can then explore the results using a range of accessor functions. The significant genes can be returned with the `getSignificantGenes` function.

```{r}
head(getSignificantGenes(adjustedPStageWise))
```

Similar, the significant transcripts can be returned with `getSginificantTx`.

```{r}
head(getSignificantTx(adjustedPStageWise))
```

The stage-wise adjusted p-values are returned using the `getAdjustedPValues` function. The screening (gene) hypothesis p-values were adjusted according to the BH FDR criterion and the confirmation (transcript) hypotheses were adjusted with the specified FWER control. Hence, the confirmation p-values returned from this function should be compared to the BH adjusted significance level of the first stage. The function returns a matrix where the different rows correspond to transcripts and the rownames correspond to gene and transcript identifiers separated with a dot:

```{r}
padj = getAdjustedPValues(adjustedPStageWise)
head(padj)
```

Similar as in the DGE case study, a 0/1 matrix that indicates significance of the tests can be retrieved with the `getResults` function:

```{r}
res=getResults(adjustedPStageWise)
head(res)
```

To show how to use the adjusted p-values we can recreate this result ourselves:

```{r}
colSums(res)

sum(res[,1]) ; sum(getAdjustedPValues(adjustedPStageWise)[,1]<=0.05)

sum(res[,2]) ; sum(getAdjustedPValues(adjustedPStageWise)[,2]<=adjustedAlphaLevel(adjustedPStageWise))
```


# References


